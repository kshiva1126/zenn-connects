---
title: "EC-CUBEã‚’Google App Engineã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹éš›ã«ã¯ã¾ã£ãŸãƒã‚¤ãƒ³ãƒˆ"
emoji: "ğŸ’¨"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
    - "eccube"
    - "symfony"
    - "gcp"
    - "googleappengine"
    - "cloudsql"
published: true
---

å…ˆæ—¥EC-CUBEã‚’Google App Engineä¸Šã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹éš›ã«ã¯ã¾ã£ãŸãƒã‚¤ãƒ³ãƒˆãŒã„ãã¤ã‹ã‚ã‚Šã¾ã—ãŸã®ã§ã€ä»Šå¾Œå›°ã‚‰ãªã„ã‚ˆã†ã«å‚™å¿˜éŒ²ã¨ã—ã¦ã¾ã¨ã‚ã¾ã™ã€‚

## ç’°å¢ƒ
EC-CUBE 4.2
Symfony 5.4
PHP 7.4
MySQL 5.7

## ãƒ­ã‚°ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã†ã¾ãå‡ºåŠ›ã§ããªã„
EC-CUBEã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã ã¨ `var/` é…ä¸‹ã«ãƒ­ã‚°ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œæˆã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ãŒã€App Engineã‹ã‚‰ä½œæˆã§ããšã‚¨ãƒ©ãƒ¼ã¨ãªã£ã¦ã„ã¾ã—ãŸã€‚

### ãƒ­ã‚°å¯¾å¿œ
ãƒ­ã‚°ã®å‡ºåŠ›å…ˆã‚’æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã«å¤‰æ›´ã—ã€ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼ã§æ‹¾ã£ã¦ã‚‚ã‚‰ã†ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

:::details app/config/eccube/packages/prod/monolog.yml
``` yaml
monolog:
    handlers:
        e_user_deprecated_filter:
            type: filter
            accepted_levels: ['info']
            channels: ['php']
            handler: blackhole
            bubble: false
        main:
            type: fingers_crossed
            action_level: error
            passthru_level: info
            handler: main_rotating_file
        main_rotating_file:
            # type: rotating_file
            # max_files: 60
            # path: '%kernel.logs_dir%/%kernel.environment%/site.log'
            # formatter: eccube.log.formatter.line
            # level: debug
            type: stream
            path: "php://stderr"
            level: debug
        front:
            type: fingers_crossed
            action_level: error
            passthru_level: info
            handler: front_rotating_file
            channels: ['front', 'app', 'php']
        front_rotating_file:
            # type: rotating_file
            # max_files: 60
            # path: '%kernel.logs_dir%/%kernel.environment%/front.log'
            # formatter: eccube.log.formatter.line
            # level: debug
            type: stream
            path: "php://stderr"
            level: debug
        admin:
            type: fingers_crossed
            action_level: error
            passthru_level: info
            handler: admin_rotating_file
            channels: ['admin', 'app', 'php']
        admin_rotating_file:
            # type: rotating_file
            # max_files: 60
            # path: '%kernel.logs_dir%/%kernel.environment%/admin.log'
            # formatter: eccube.log.formatter.line
            # level: debug
            type: stream
            path: "php://stderr"
            level: debug
        console:
            type: console
            process_psr_3_messages: false
            channels: ['!event', '!doctrine']
        # keep this last
        blackhole:
            type: "null"
```
:::

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥
ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ä¿å­˜å ´æ‰€ã‚’App EngineãŒæ›¸ãè¾¼ã‚ã‚‹tmpé…ä¸‹ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚ã“ã“ã§ã¯å¿µã®ãŸã‚ãƒ­ã‚°ã®å‡ºåŠ›å…ˆã‚‚tmpé…ä¸‹ã«å¤‰ãˆã¦ã„ã¾ã™ã€‚

:::details src/Eccube/Kernel.php
``` php
    public function getCacheDir()
    {
        if ($this->environment === 'prod') {
            return '/tmp/var/cache/'.$this->environment;
        }
        return $this->getProjectDir().'/var/cache/'.$this->environment;
    }

    public function getLogDir()
    {
        if ($this->environment === 'prod') {
            return '/tmp/var/log';
        }
        return $this->getProjectDir().'/var/log';
    }
```
:::

### ã‚»ãƒƒã‚·ãƒ§ãƒ³
ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¿å­˜å ´æ‰€ã‚’DBã«å¤‰æ›´ã—ã¾ã—ãŸã€‚
å‚è€ƒ: https://doc4.ec-cube.net/session_handler_settings#rdbms%E3%81%AB%E4%BF%9D%E5%AD%98%E3%81%99%E3%82%8B

:::message alert
ä¸Šè¨˜ã®ãƒšãƒ¼ã‚¸ã‚’å‚è€ƒã«sessionsãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ãŸã¨ã“ã‚ã€ãªãœã‹ã€sess_lifetimeã«ç™»éŒ²ã•ã‚Œã‚‹æ–‡å­—åˆ—é•·ãŒãƒ‡ãƒ¼ã‚¿å‹(`MEDIUMINT`)ã‚’ä¸Šå›ã£ã¦ãŠã‚Šã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã—ãŸã€‚
ãã®ãŸã‚ã€sess_lifetimeã®ãƒ‡ãƒ¼ã‚¿å‹ã‚’sess_timeã«åˆã‚ã›ã¦`INTEGER UNSIGNED`ã¨å¤‰æ›´ã—ã¾ã—ãŸã€‚
:::

## CSSã€JSã€ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒé…ä¿¡ã•ã‚Œãªã„
ã“ã¡ã‚‰ã¯app.yamlã«ä»¥ä¸‹ã®handlersã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§é…ä¿¡ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

:::details app.yaml
```
handlers:
  - url: /html/template/admin/assets
    static_dir: html/template/admin/assets
  - url: /html/template/default/assets
    static_dir: html/template/default/assets
  - url: /html/user_data/assets
    static_dir: html/user_data/assets
  - url: /html/upload/save_image
    static_dir: html/upload/save_image
  - url: /html/bundle
    static_dir: html/bundle
```
:::

## Cloud SQLã«æ¥ç¶šã§ããªã„
ã“ã“ã¯éå¸¸ã«ã¯ã¾ã‚Šã¾ã—ãŸã€‚ãƒˆãƒ©ã‚¤ã‚¢ãƒ³ãƒ‰ã‚¨ãƒ©ãƒ¼ã§ä½•ã¨ã‹æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã®ã§ãã®è¨­å®šã‚’è¨˜è¼‰ã—ã¦ãŠãã¾ã™ã€‚
DBåã‚’é‡è¤‡ã—ã¦è¨­å®šã—ã¦ã„ã‚‹ã®ãŒãƒŸã‚½ã§ã™ã€‚ã“ã‚Œã§ãªãœã‹å‹•ãã¾ã—ãŸ()

```
DATABASE_URL: mysql://[ãƒ¦ãƒ¼ã‚¶å]:[ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰]@localhost/[DBå]?unix_socket=/cloudsql/[CloudSQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ¥ç¶šå]&dbname=[DBå]

ä¾‹)
DATABASE_URL: mysql://user:password@localhost/eccubedb?unix_socket=/cloudsql/xxx:asia-nortieast1:instance-name&dbname=eccubedb
```

